---
title: "Analyses Part II"
author: "chfal"
date: "6/30/2020"
output: html_document
---

Here are the packages needed.

```{r}
library(readr) # for reading data
library(dplyr) # for cleaning data
library(MASS) # for analysis
library(lme4) # for analysis
library(glmmTMB) # for analysis
library(gamm4) # for analysis
library(xts) # to cut 
library(ggplot2)
```


```{r}
# read in data
final_apple <- read_csv("final_apple_corr.csv")

final_google <- read_csv("final_google_corr.csv")
```

```{r}
# make two for google data: one with all means across column and one with all means except housing increase
final_google$expected_decrease <- base::rowMeans(final_google[,c(3,4,6,7,8)])

final_google$all_mean <- rowMeans(final_google[,c(3,4,5,6,7,8)])
```


```{r}
# corelation offset by two weeks using lag operator
lag <- final_google %>%
  dplyr::select(c("start_date", "state", "R0")) %>%
  group_by(state) %>%
  mutate(lagged_R0 = lag(R0)) %>%
  mutate(lagged_R0 = lag(lagged_R0))


lagged_google <- left_join(lag, final_google, by=c("start_date", "state", "R0"))
lagged_apple <- left_join(lag, final_apple, by=c("start_date", "state", "R0"))
```

Now we are going to correllate with lagged data. We still have a lot of noise. We should think about binning and also controlling by state? Could state be a categorical factor which might explain a lot of the variation?

```{r}
plot(lagged_google$lagged_R0, lagged_google$expected_decrease)
lm(lagged_google$lagged_R0 ~ lagged_google$expected_decrease, na.rm=T)
summary(lm(lagged_google$lagged_R0 ~ lagged_google$expected_decrease, na.rm=T))
#adjusted r-squareed is .059
```

Comparing we can see that there is 

```{r}
plot(lagged_apple$lagged_R0, lagged_apple$value)
lm(lagged_apple$lagged_R0~lagged_apple$value)
summary(lm(lagged_apple$lagged_R0~lagged_apple$value))
```

```{r}
aov(lagged_apple$lagged_R0 ~ lagged_apple$value*lagged_apple$temp_in_K)
lm(lagged_apple$lagged_R0 ~ lagged_apple$temp_in_K)
```

```{r}
plot(1/lagged_apple$temp_in_K, log(lagged_apple$lagged_R0))
summary(lm(log(lagged_apple$lagged_R0) ~ 1/lagged_apple$temp_in_K))

```


# Mobility and Masks - Google

```{r}
aov(lagged_google$R0 ~ lagged_google$expected_decrease + lagged_google$masks_worn)
summary(aov(lagged_google$R0 ~ lagged_google$expected_decrease + lagged_google$masks_worn))
```

# Mobility and Masks - Apple
```{r}
aov(lagged_apple$R0 ~ lagged_apple$value + lagged_apple$masks_worn)
summary(aov(lagged_apple$R0 ~ lagged_apple$value + lagged_apple$masks_worn))
```

# States and Mobility Data - Apple
```{r}
aov(lagged_apple$R0 ~ lagged_apple$value + lagged_apple$state)
summary(aov(lagged_apple$R0 ~ lagged_apple$value + lagged_apple$state))
```

# States and Mobility - Google
```{r}
aov(lagged_google$R0 ~ lagged_google$expected_decrease + lagged_google$state)
summary(aov(lagged_google$R0 ~ lagged_google$expected_decrease + lagged_google$state))
```


# Let's make some sick graphs lol

## Mask Data on R0 by State

```{r, out.width="100%"}
ggplot(lagged_google, aes(lagged_R0, fill=state)) +
  geom_boxplot() +
  facet_wrap(~state) +
  theme(legend.position="none", axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
  labs(title="R0 by State") +
  ggsave("state_r0.png")

#all states
ggplot(lagged_google, aes(x=masks_worn, y=lagged_R0)) +
  geom_boxplot() +
  facet_wrap(~state)

# this is too crazy, let's make it states with mask mandatesa
states_w_masks <- lagged_google %>%
  filter_at(vars(state), any_vars(TRUE %in% c(masks_worn)))

ggplot(data=states_w_masks, aes(x=masks_worn, y=R0, fill=masks_worn)) +
  geom_boxplot() +
  facet_wrap(~state) +
  theme(legend.position="none") +
  scale_x_discrete(breaks=c("TRUE", "FALSE"), labels=c("Masks", "No Masks")) +
  labs(x="Mask Mandate", y="R0", title="R0 before and after Statewide Mask Mandates") +
  ggsave("state_w_masks_r0.png")
```

## Weather and R0 by State

```{r, out.width="100%"}
ggplot(lagged_apple, aes(x=temp_in_K, y=R0, color=state)) + 
  geom_point() +
  facet_wrap(~state) +
  labs(title="Weather and R0 by State") +
  theme(legend.position="none") +
  ggsave("weather_r0.png")


```


```{r, out.width="100%"}
ggplot(lagged_apple, aes(x=value, y=lagged_R0, color=state)) +
  geom_point() +
  facet_wrap(~state) +
  labs(title="Apple Mobility Data and R0, Lagged by Two Weeks, by State") +
  theme(legend.position="none") +
  ggsave("apple_mobility_r0_lagged.png")
```


```{r}
ggplot(lagged_google, aes(x=expected_decrease, y=lagged_R0, color=state)) +
  geom_point() +
  facet_wrap(~state) +
  labs(title="Expected Decrease from Google Mobility Data and R0, Lagged by Two Weeks, by State") +
  theme(legend.position="none") +
  ggsave("google_mobility_r0_lagged.png")
```
```